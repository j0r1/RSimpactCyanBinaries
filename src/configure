#!/bin/bash

PREF=simpact-cyan-0.21.0
STARTDIR=`pwd`

if [ -z "$CXX" ] ; then
	CXX="g++"
fi

mkdir ../exec/
mkdir ../inst/
mkdir ../inst/simpact/ 
mkdir local

cp -r $PREF/data ../inst/simpact/
cp -r $PREF/python ../inst/simpact/

# Test OpenMP support
echo "Testing compiler's OpenMP support"
cat << EOF >test0.cpp
#include <omp.h>

int main(void) 
{ 
	return 0; 
}
EOF
if ! $CXX -o test0 test0.cpp -fopenmp ; then
	OPENMPFLAGS="-DDISABLEOPENMP"
else
	OPENMPFLAGS="-fopenmp"
fi

echo "OPENMPFLAGS=$OPENMPFLAGS"
sleep 5

echo "Building GSL"
(
cd gsl-1.16/ ; 
CFLAGS=-O2 ./configure --prefix="$STARTDIR/local" 

# Documentation does not need to be built or installed, disable this to avoid errors at this point
cat << EOF > doc/Makefile
all:

install:

EOF

make && make install) #>/dev/null

echo "Building TIFF"
(cd tiff-4.0.6/ ; CFLAGS=-O2 ./configure --prefix="$STARTDIR/local" --disable-jpeg --disable-lzma && make && make install) #>/dev/null

LIBGSL=`find local/ -name libgsl.a`
LIBGSLCBLAS=`find local/ -name libgslcblas.a`
LIBTIFF=`find local/ -name libtiff.a`

INCLUDES="-I$STARTDIR/local/include
         -I$PREF/src/ 
	 -I$PREF/src/lib 
	 -I$PREF/src/lib/core 
         -I$PREF/src/lib/mnrm 
         -I$PREF/src/lib/util 
	 -I$PREF/src/lib/util/experimental
	 -I$PREF/src/program 
	 -I$PREF/src/program-common "

COMMONSRC="./$PREF/src/lib/mnrm/booltype.cpp \
./$PREF/src/lib/mnrm/algorithm.cpp 
./$PREF/src/lib/mnrm/eventbase.cpp 
./$PREF/src/lib/mnrm/gslrandomnumbergenerator.cpp 
./$PREF/src/lib/mnrm/debugtimer.cpp 
./$PREF/src/lib/mnrm/simplealgorithm.cpp 
./$PREF/src/lib/core/personaleventlisttesting.cpp 
./$PREF/src/lib/core/populationstateadvanced.cpp 
./$PREF/src/lib/core/personaleventlist.cpp 
./$PREF/src/lib/core/populationutil.cpp 
./$PREF/src/lib/core/populationalgorithmsimple.cpp 
./$PREF/src/lib/core/populationevent.cpp 
./$PREF/src/lib/core/populationstatesimpleadvancedcommon.cpp 
./$PREF/src/lib/core/populationstatesimple.cpp 
./$PREF/src/lib/core/populationalgorithmadvanced.cpp 
./$PREF/src/lib/core/populationalgorithmtesting.cpp 
./$PREF/src/lib/core/populationstatetesting.cpp 
./$PREF/src/lib/core/personbase.cpp 
./$PREF/src/lib/util/populationdistribution.cpp 
./$PREF/src/lib/util/piecewiselinearfunction.cpp 
./$PREF/src/lib/util/discretedistribution2d.cpp 
./$PREF/src/lib/util/hazardfunction.cpp 
./$PREF/src/lib/util/populationdistributioncsv.cpp 
./$PREF/src/lib/util/jsonconfig.cpp 
./$PREF/src/lib/util/normaldistribution.cpp 
./$PREF/src/lib/util/configreader.cpp 
./$PREF/src/lib/util/discretedistribution.cpp 
./$PREF/src/lib/util/tiffdensityfile.cpp 
./$PREF/src/lib/util/configwriter.cpp 
./$PREF/src/lib/util/csvfile.cpp 
./$PREF/src/lib/util/configdistributionhelper.cpp 
./$PREF/src/lib/util/logfile.cpp 
./$PREF/src/lib/util/binormaldistribution.cpp 
./$PREF/src/lib/util/discretedistributionwrapper2d.cpp 
./$PREF/src/lib/util/configsettings.cpp 
./$PREF/src/lib/util/configfunctions.cpp 
./$PREF/src/lib/util/mutex.cpp 
./$PREF/src/lib/util/gridvaluescsv.cpp 
./$PREF/src/lib/util/util.cpp 
./$PREF/src/lib/util/discretedistributionwrapper.cpp 
./$PREF/src/lib/util/discretedistributionfast.cpp 
./$PREF/src/program-common/eventhivtransmission.cpp 
./$PREF/src/program-common/simpactpopulation.cpp 
./$PREF/src/program-common/eventhsv2seed.cpp 
./$PREF/src/program-common/evthazarddissolution.cpp 
./$PREF/src/program-common/person_relations.cpp 
./$PREF/src/program-common/eventdiagnosis.cpp 
./$PREF/src/program-common/eventformation.cpp 
./$PREF/src/program-common/person.cpp 
./$PREF/src/program-common/configutil.cpp 
./$PREF/src/program-common/hazardfunctionformationsimple.cpp 
./$PREF/src/program-common/eventbirth.cpp 
./$PREF/src/program-common/eventmortality.cpp 
./$PREF/src/program-common/simpactevent.cpp 
./$PREF/src/program-common/aidstodutil.cpp 
./$PREF/src/program-common/hazardfunctionformationagegap.cpp 
./$PREF/src/program-common/main.cpp 
./$PREF/src/program-common/eventaidsstage.cpp 
./$PREF/src/program-common/vspmodellogdist.cpp 
./$PREF/src/program-common/eventdissolution.cpp 
./$PREF/src/program-common/eventcheckstopalgorithm.cpp 
./$PREF/src/program-common/eventaidsmortality.cpp 
./$PREF/src/program-common/eventdebut.cpp 
./$PREF/src/program-common/evthazardformationsimple.cpp 
./$PREF/src/program-common/eventdropout.cpp 
./$PREF/src/program-common/eventrelocation.cpp 
./$PREF/src/program-common/eventsyncpopstats.cpp 
./$PREF/src/program-common/eventhivseed.cpp 
./$PREF/src/program-common/eventchronicstage.cpp 
./$PREF/src/program-common/main_hazardtest.cpp 
./$PREF/src/program-common/person_hiv.cpp 
./$PREF/src/program-common/eventseedbase.cpp 
./$PREF/src/program-common/eventmortalitybase.cpp 
./$PREF/src/program-common/eventperiodiclogging.cpp 
./$PREF/src/program-common/vspmodellogweibullwithnoise.cpp 
./$PREF/src/program-common/evthazardformationagegaprefyear.cpp 
./$PREF/src/program-common/logsystem.cpp 
./$PREF/src/program-common/eventintervention.cpp 
./$PREF/src/program-common/configsettingslog.cpp 
./$PREF/src/program-common/signalhandlers.cpp 
./$PREF/src/program-common/eventconception.cpp 
./$PREF/src/program-common/eventsyncrefyear.cpp 
./$PREF/src/program-common/person_hsv2.cpp 
./$PREF/src/program-common/hazardfunctionformationagegaprefyear.cpp 
./$PREF/src/program-common/eventhsv2transmission.cpp 
./$PREF/src/program-common/coarsemap.cpp 
./$PREF/src/program-common/evthazardformationagegap.cpp "


SIMPACTSRC="./$PREF/src/program/personimpl.cpp 
./$PREF/src/program-common/eventmonitoring.cpp 
./$PREF/src/program/start.cpp "


MAXARTSRC="./$PREF/src/program-maxart/personimpl.cpp 
./$PREF/src/program-maxart/eventstudystep.cpp 
./$PREF/src/program-maxart/facilities.cpp 
./$PREF/src/program-maxart/eventmonitoring.cpp 
./$PREF/src/program-maxart/eventstudyend.cpp 
./$PREF/src/program-maxart/eventstudystart.cpp 
./$PREF/src/program-maxart/start.cpp 
./$PREF/src/program-maxart/maxartpopulation.cpp "

SIMPACTVERSION=`echo "$PREF" | cut -f 3 -d "-"`
GCCVERSION=`gcc --version|head -n 1`
cat << EOF > $PREF/src/version.h
#ifndef SIMPACT_CYAN_VERSION_H

#define SIMPACT_CYAN_VERSION_H

#define SIMPACT_CYAN_VERSION    "$SIMPACTVERSION"
#define SIMPACT_CYAN_COMPILER   "$GCCVERSION"

#endif // SIMPACT_CYAN_VERSION_H
EOF

DEFINES="-DEVENTBASE_ALWAYS_CHECK_NANTIME -DTIFFVERSION=4"

# Release
echo "Compiling simpact-cyan-release"
$CXX -std=c++11 $OPENMPFLAGS -DNDEBUG -O2 -o ../exec/simpact-cyan-release $DEFINES $INCLUDES $COMMONSRC $SIMPACTSRC $LIBGSL $LIBGSLCBLAS $LIBTIFF -lz
echo "Compiling maxart-release"
$CXX -std=c++11 $OPENMPFLAGS -DNDEBUG -O2 -o ../exec/maxart-release $DEFINES $INCLUDES $COMMONSRC $MAXARTSRC $LIBGSL $LIBGSLCBLAS $LIBTIFF -lz

# Debug
echo "Compiling simpact-cyan-debug"
$CXX -std=c++11 $OPENMPFLAGS -g -o ../exec/simpact-cyan-debug $DEFINES $INCLUDES $COMMONSRC $SIMPACTSRC $LIBGSL $LIBGSLCBLAS $LIBTIFF -lz
echo "Compiling maxart-debug"
$CXX -std=c++11 $OPENMPFLAGS -g -o ../exec/maxart-debug $DEFINES $INCLUDES $COMMONSRC $MAXARTSRC $LIBGSL $LIBGSLCBLAS $LIBTIFF -lz

